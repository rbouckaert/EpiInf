#+TITLE: Conditional Sampling Validation
#+AUTHOR: Tim

* Validation for r=1
  
In order to ensure that the conditioned sampling tree prior is
correct, we directly simulate trees under the conditioned sampling
model and compare this distribution to that obtained using our
particle filter-based tree prior via MCMC.

In particular, we use the script directSimulation.xml (found in the
validation/ConditionedSampling directory of the EpiInf repository) to
simulate $10^5$ trees, each with 5 leaves sampled at times 6, 7, 8, 9
and 10 following the start of a linear BD process.  The birth rate is
set to 1.05 and the death rate to 1.  (This small difference in rates
means that the simulated population size rarely becomes unmanageable.)

In this initial test we fix the removal probability to 1, meaning that
the distribution should have no ``sampled ancestor'' nodes.

We then use the script mcmc.xml (found in the same directory) to
sample trees from the same distribution using the particle MCMC
algorithm.

First, let's load the results of the analyses:

#+BEGIN_SRC R :session
df_direct <- read.table("directSimulation.log", header=T, sep="\t")
df_mcmc <- read.table("mcmc.log", header=T, sep="\t")[-(1:100),]
#+END_SRC

#+RESULTS:

We wll now compare the distributions obtained.

** Tree Height
  
The following compares the distributions of tree heights obtained,
demonstrating agreement between the methods.
  
#+BEGIN_SRC R :session :file th_compare.png :results graphics :exports both
  th_direct <- hist(df_direct$tree.height, breaks=seq(4,10,length.out=20))
  th_mcmc <- hist(df_mcmc$tree.height, breaks=seq(4,10,length.out=20))

  plot(th_direct$mids, th_direct$density, 'o', col='red',
       main="Tree height comparison", xlab="Tree Height", ylab="Density")
  lines(th_mcmc$mids, th_mcmc$density, 'o', col='blue')

  legend('bottomright', inset=0.05, c("Direct Simulation", "MCMC"),
         col=c("red","blue"), lty=1, pch=1)
#+END_SRC

#+RESULTS:
[[file:th_compare.png]]

** Tree Length
  
The following compares the distributions of tree lengths (total edge
length) generated by the different methods.  These also seem to agree
nicely.

#+BEGIN_SRC R :session :file tl_compare.png :results graphics :exports both
  tl_direct <- hist(df_direct$tree.treeLength, breaks=seq(0,40,length.out=20))
  tl_mcmc <- hist(df_mcmc$tree.treeLength, breaks=seq(0,40,length.out=20))

  plot(tl_direct$mids, tl_direct$density, 'o', col='red',
       main="Tree length comparison", xlab="Tree Length", ylab="Density")
  lines(tl_mcmc$mids, tl_mcmc$density, 'o', col='blue')

  legend('topright', inset=0.05, c("Direct Simulation", "MCMC"),
         col=c("red","blue"), lty=1, pch=1)
#+END_SRC

#+RESULTS:
[[file:tl_compare.png]]


* Validation with r<1

We now repeat the validation above but with the removal probability
fixed to 0.5, meaning that sampled ancestors should be present in the
sampled trees.

#+BEGIN_SRC R :session :results none
  df_directSA <- read.table("directSimulationSA.log", header=T, sep="\t")
  df_mcmcSA <- read.table("mcmcSA.log", header=T, sep="\t")
  nsamp <- dim(df_mcmcSA)[1]
  df_mcmcSA <- df_mcmcSA[-(1:ceiling(0.1*nsamp)),]
#+END_SRC

Again with both the tree height and tree length distributions we see
agreement between the two sampling approaches.

** Tree Height
   

#+BEGIN_SRC R :session :file th_compareSA.png :results graphics :exports both
  th_directSA <- hist(df_directSA$tree.height, breaks=seq(4,10,length.out=50))
  th_mcmcSA <- hist(df_mcmcSA$tree.height, breaks=seq(4,10,length.out=50))

  plot(th_directSA$mids, th_directSA$density, 'o', col='red', ylim=c(0,0.5),
       main="Tree height comparison", xlab="Tree Height", ylab="Density")
  lines(th_mcmcSA$mids, th_mcmcSA$density, 'o', col='blue')

  legend('bottomright', inset=0.05, c("Direct Simulation", "MCMC"),
         col=c("red","blue"), lty=1, pch=1)
#+END_SRC

#+RESULTS:
[[file:th_compareSA.png]]

** Tree Length
   
#+BEGIN_SRC R :session :file tl_compareSA.png :results graphics :exports both
  tl_directSA <- hist(df_directSA$tree.treeLength, breaks=seq(0,40,length.out=50))
  tl_mcmcSA <- hist(df_mcmcSA$tree.treeLength, breaks=seq(0,40,length.out=50))

  plot(tl_directSA$mids, tl_directSA$density, 'o', col='red', ylim=c(0,0.06),
       main="Tree length comparison", xlab="Tree Length", ylab="Density")
  lines(tl_mcmcSA$mids, tl_mcmcSA$density, 'o', col='blue')

  legend('topright', inset=0.05, c("DirectSA Simulation", "MCMC"),
         col=c("red","blue"), lty=1, pch=1)
#+END_SRC

#+RESULTS:
[[file:tl_compareSA.png]]

